# 4.2 피처 엔지니어링 — 반도체 도메인 지식의 활용

## 이 챕터에서 배우는 것
- 피처 엔지니어링이 반도체 AI에서 특히 중요한 이유
- FDC Summary 피처 추출 — 통계량, 구간별 분석
- Trace 피처 추출 — 시계열 특징, 주파수 분석
- 도메인 지식 기반 피처 — 물리 모델에서 파생
- 공간 피처 — 웨이퍼 좌표, 필드 위치
- 피처 선택과 차원 축소

---

## 왜 피처 엔지니어링이 핵심인가: 모델보다 피처가 먼저다

이전 챕터에서 문제를 올바르게 정의하는 법을 배웠다. 문제가 정의되면 다음 질문은 — "어떤 데이터를 **어떤 형태로** 모델에 넣을 것인가?"다. 이것이 **피처 엔지니어링(Feature Engineering)**이다.

반도체 AI에서 **모델 선택보다 피처 엔지니어링이 성능에 더 큰 영향**을 미치는 경우가 많다. 이 주장을 세 가지 근거로 뒷받침하겠다.

첫째, 원시 데이터를 그대로 쓸 수 없다. 3.4장에서 FDC Trace가 웨이퍼당 수만~수십만 개의 시계열 포인트라고 배웠다. 이것을 그대로 모델에 넣으면 **차원의 저주(Curse of Dimensionality)**에 빠진다 — 피처 수가 샘플 수보다 훨씬 많아져 오버피팅이 필연적이다.

둘째, 수십 년간 축적된 반도체 물리/공학 지식을 피처로 인코딩하면 모델이 훨씬 효율적으로 학습한다. Rayleigh 방정식(2.6장), Overlay 선형 모델(2.10장), Dose-CD 관계(2.11장) — 이 물리적 관계를 피처로 표현하면, 모델이 이 관계를 데이터에서 처음부터 발견할 필요 없이 **이미 인코딩된 지식** 위에서 잔차만 학습하면 된다.

셋째, 잘 설계된 피처는 **해석 가능**하다. "PEB_온도_편차 피처가 CD 예측에 가장 큰 기여"라는 Feature Importance는 엔지니어가 즉시 이해하고 행동으로 연결할 수 있다. "CNN의 3번째 레이어 42번 뉴런이 활성화"보다 훨씬 유용하다.

---

## FDC Summary 피처: 가장 보편적인 출발점

### 기본 통계량

3.4장에서 FDC Summary가 각 센서의 공정 스텝별 통계값이라고 배웠다. 이 통계값이 피처의 첫 번째 층위다.

**Mean(평균)**은 공정 조건의 기본 수준을, **Std(표준편차)**는 공정 안정성/변동성을, **Min/Max**는 이상 스파이크의 유무를, **Range(Max-Min)**는 변동 범위를 나타�다. 여기에 분포의 비대칭을 나타내는 **Skewness(왜도)**와 꼬리 두께(이상값 경향)를 나타내는 **Kurtosis(첨도)**를 추가하면, 단순 평균/표준편차만으로는 잡지 못하는 분포의 형태 정보를 포착할 수 있다.

### 구간별 분석: 시간을 나누면 정보가 늘어난다

하나의 공정 스텝이 60초라면, 전체 60초의 평균 하나로는 초기 안정화 구간의 특이한 행동이 묻혀버린다. 스텝을 시간 구간으로 세분화하면 정보가 풍부해진다.

```
식각 메인 스텝 (60초):
├── 초기 10초: Mean_RF=498W, Std_Pressure=0.3mTorr, ...
├── 중간 40초: Mean_RF=500W, Std_Pressure=0.1mTorr, ...
└── 말기 10초: Mean_RF=501W, Std_Pressure=0.5mTorr, ...
```

초기의 안정화 시간(Settling Time)이 길면 가스 공급에 문제가 있을 수 있고, 말기의 변동이 커지면 엔드포인트 근처의 식각 불균일을 시사한다. 이 정보가 전체 평균에서는 사라지지만, 구간별 분석에서는 살아난다.

### 센서 간 파생 피처: 물리적 의미를 담는다

개별 센서의 통계값뿐 아니라, **센서 간의 비율이나 차이**에서 물리적으로 의미 있는 피처를 만들 수 있다.

```
RF_Power / Gas_Flow      → 단위 가스당 에너지 = 에너지 밀도 대리 변수
Chamber_Pressure × Time  → 압력-시간 적분 = 총 노출량 대리 변수
Temp_Top - Temp_Bottom   → 챔버 내 온도 구배
```

이 파생 피처들은 물리적 의미가 명확하므로 해석성이 높고, 개별 센서값보다 CD/수율과의 상관이 높은 경우가 많다.

---

## Trace 피처 추출: 시계열에서 정보를 짜낸다

Summary는 Trace의 "요약"이므로 필연적으로 정보가 손실된다. Trace에서 직접 피처를 추출하면 Summary에서 놓치는 패턴을 포착할 수 있다.

### 형상 특징 (Shape Features)


![Trace 형상 피처 — Settling Time과 Overshoot](https://image-proxy.jenghun-suh.workers.dev/images/04_02/trace_settling_overshoot.png)

Trace의 **시간적 형태(Shape)**에서 추출하는 피처다.

**Settling Time** — 센서값이 목표의 ±2% 이내로 안정화되는 데 걸리는 시간. 가스 공급 시스템의 응답 속도를 반영한다. **Overshoot** — 목표값을 초과하는 최대 비율. 제어 시스템의 특성을 반영한다. **Rise Time** — 10%에서 90%까지 도달하는 시간. **AUC(Area Under Curve)** — 곡선 아래 면적. 총 에너지/노출량의 대리 변수다.

이 형상 피처들은 공정 제어 이론(Control Theory)에서 온 개념으로, Step Response의 특성을 정량화한다. 여러분이 시스템의 응답 시간(Response Time), 오버슈트(Spike), 안정화 시간(Settling)을 모니터링하는 것과 정확히 같은 개념이 물리적 센서 신호에 적용된 것이다.

### 주파수 특징 (Frequency Features)

**FFT(Fast Fourier Transform)**로 시계열을 주파수 영역으로 변환하면, 시간 영역에서는 보이지 않는 **주기적 패턴**이 드러난다. 특정 주파수 대역의 에너지가 높으면 진동이나 간섭이 있다는 뜻이고, 지배 주파수(Dominant Frequency)가 변하면 장비 특성이 바뀌었다는 신호다. 플라즈마 공정에서 RF 신호의 주파수 분석이 특히 유용하다 — 플라즈마의 불안정성이 특정 주파수의 진동으로 나타나기 때문이다.

### 자동화된 특징 추출

수동 피처 설계가 어려울 때 자동화 도구가 도움이 된다. **tsfresh**는 Python 라이브러리로, 시계열에서 수백 개의 통계적 특징을 자동으로 추출하고, 타겟 변수와의 통계적 유의성으로 필터링하여 관련 있는 피처만 남긴다. **Catch22**는 시계열 분류 연구에서 검증된 22개의 표준적 특징을 빠르게 추출한다. **1D-CNN**은 원시 Trace를 직접 입력하여 모델이 특징을 자동 학습하는 End-to-End 접근으로, 피처 엔지니어링 자체를 생략하는 대신 데이터가 풍부해야 하고 해석성이 떨어진다.

---

## 도메인 지식 기반 피처: 가장 가치 높은 피처

Part 2에서 배운 물리/공학 지식을 피처로 인코딩하면, 순수 데이터 드리븐 피처보다 **극적으로** 성능이 향상된다. 이것이 반도체 AI에서 도메인 전문가의 참여가 필수적인 이유다.

### Overlay 관련 도메인 피처

2.10장의 Overlay 선형 모델(Translation, Rotation, Magnification)의 각 성분을 정렬 데이터에서 피팅하여 피처로 사용한다. 선형 모델의 **잔차(Residual)** — 선형 모델이 설명하지 못하는 부분 — 을 별도 피처로 사용하면, ML이 비선형 성분(HOWA, CPE)을 학습하는 데 집중할 수 있다. 이것이 SMILE 플랫폼의 핵심 접근이다 — 물리 모델이 설명하는 부분은 물리 모델에 맡기고, ML은 물리 모델의 잔차만 학습한다.

### CD 관련 도메인 피처

2.6장의 Rayleigh 방정식과 2.11장의 Dose-CD 관계에서 파생한다.

```
Dose × 레지스트_두께      → 총 흡수 에너지 (CD에 1차적 영향)
Focus_오차²              → 디포커스의 CD 영향 (2차 관계, 부호 무관)
PEB_온도 × PEB_시간      → 총 열 노출량 (화학 증폭 정도)
```

특히 **Focus_오차²**은 중요하다. 2.6장에서 Focus와 CD의 관계가 2차 함수(포물선)라고 배웠는데, 원시 Focus 값을 피처로 넣으면 모델이 이 2차 관계를 데이터에서 학습해야 하지만, Focus²을 피처로 만들면 **선형 모델로도** 이 관계를 포착할 수 있다.

### 장비 상태 관련 피처

3.4장에서 PM 이후 장비 상태가 시간에 따라 변한다고 배웠다. 이것을 피처로 직접 인코딩한다.

```
PM_이후_웨이퍼_수     → 장비 열화 정도의 대리 변수
마지막_세정_이후_시간  → 챔버 오염 축적 정도
당일_처리_웨이퍼_수   → 렌즈/챔버의 열적 상태
이전_제품과의_차이    → 제품 전환 시 잔류 효과
```

### Cross-Layer 피처: 종종 무시되지만 영향력이 크다


![Cross-Layer 피처 효과 — R² 비교](https://image-proxy.jenghun-suh.workers.dev/images/04_02/cross_layer_r2_comparison.png)

이전 층의 공정 결과가 현재 층에 미치는 영향은 크지만, 3.8장에서 다룬 데이터 매칭의 어려움 때문에 종종 무시된다. 하지만 매칭에 성공하면 보상이 크다 — **Cross-Layer 피처를 포함하면 예측 정확도가 10~30% 향상**되는 경우가 많다.

```
이전_층_CD             → 현재 층 식각의 출발점에 영향
이전_층_Overlay         → 누적 정렬 오차
이전_층_막_두께         → 현재 층 Focus/DOF에 영향
```

---

## 공간 피처: 위치가 결과를 결정한다

3.9장에서 반도체 데이터의 공간 구조를 배웠다. 이 구조를 피처로 명시적으로 인코딩한다.

### 웨이퍼 좌표 기반

```
Die_X, Die_Y                       → 다이의 절대 위치
Radius = √(Die_X² + Die_Y²)        → 중심으로부터의 거리 (Center-Edge 효과)
Angle = atan2(Die_Y, Die_X)         → 각도 (방향별 비대칭 효과)
Edge_Flag = (Radius > 임계값)       → 에지 다이 여부 (이진)
```

**Radius** 피처가 특히 강력하다. 스핀 코팅, CMP, 식각 등 거의 모든 공정에서 Center-Edge 변동이 존재하며, Radius 하나만으로 이 변동의 상당 부분을 포착한다.

### 필드 좌표 기반

```
Field_X, Field_Y                   → 필드 내 다이 위치
Scan_Position                      → 스캔 방향 위치 (스캔 효과)
Slit_Position                      → 슬릿 방향 위치 (조명 균일도)
```

2.10장에서 Intra-field Overlay가 필드 내 위치에 따라 변한다고 배웠는데, 이 좌표 피처가 그 변동을 포착한다.

---

## 피처 선택: 수천 개에서 핵심만 남긴다


![Feature Importance — 상위 20개 피처](https://image-proxy.jenghun-suh.workers.dev/images/04_02/feature_importance_top20.png)

FDC Summary만으로도 센서 100개 × 스텝 5개 × 통계 5종 = 2,500개 피처가 생성된다. 도메인 피처, 공간 피처까지 더하면 수천 개다. 대부분은 중복이거나 노이즈이며, 과다 피처는 **오버피팅과 학습 시간 증가**를 유발한다.

실전 권장 순서는 단계적이다. **1차 필터링**으로 분산이 0인 피처(상수)와 결측률 50% 초과 피처를 제거한다. **상관 필터**로 피처 간 상관계수 > 0.95인 쌍에서 하나를 제거하여 다중공선성을 줄인다. **모델 기반 선택**으로 XGBoost Feature Importance 상위 50~100개를 선택한다. 마지막으로 **도메인 검증**으로 선택된 피처가 물리적으로 타당한지 엔지니어와 리뷰한다 — Feature Importance가 높은데 물리적으로 설명이 안 되면 **Spurious Correlation**(가짜 상관)을 의심해야 한다.

---

## 피처 엔지니어링 체크리스트

반도체 AI 프로젝트의 피처 엔지니어링 시 확인할 사항을 정리한다.

- [ ] FDC Summary: 기본 통계 + 구간별 통계 추출했는가?
- [ ] Trace 특징: 형상/주파수 특징 또는 자동 추출 적용했는가?
- [ ] 도메인 피처: 물리 모델 기반 파생 피처(Focus², Dose×두께 등) 포함했는가?
- [ ] 장비 상태: PM 이후 시간, 가동 이력 등 포함했는가?
- [ ] Cross-Layer: 이전 층 데이터 매칭하여 포함했는가?
- [ ] 공간 좌표: Radius, Angle, 필드 위치 피처 포함했는가?
- [ ] 피처 선택: 중복/노이즈 피처 제거했는가?
- [ ] 도메인 검증: 엔지니어와 피처 리스트를 리뷰하여 물리적 타당성 확인했는가?

---

## 핵심 정리

반도체 AI에서 **피처 엔지니어링이 모델 선택보다 성능에 더 큰 영향**을 미치는 경우가 많다. **FDC Summary 피처**(센서별/스텝별 통계량 + 구간별 분석 + 센서 간 파생)가 기본이고, **Trace 피처**(형상: Settling/Overshoot, 주파수: FFT, 자동: tsfresh)로 Summary의 정보 손실을 보완한다. **도메인 지식 기반 피처**(Focus², Dose×두께, PM 이후 시간, Cross-Layer)가 가장 가치가 높으며 R² 10~30% 향상이 가능하다. **공간 피처**(Radius, Angle, 필드 좌표)가 Center-Edge 등 공간 변동을 포착하며, 피처 선택은 **Filter → Embedded → 도메인 검증**의 단계적 접근으로 수천 개에서 핵심 50~100개를 남긴다.

---

*다음 챕터: 4.3 모델 학습과 검증 — 반도체 특화 전략*
